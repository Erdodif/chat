<!DOCTYPE html>
<html>
<head>
    <title>Chat App</title>
    <style>
        #messages {
            min-height: 500px;
            overflow-y: scroll;
        }
    </style>
</head>
<body>
    <h1>Chat App</h1>
    <input type="text" id="username" placeholder="Enter your username...">
    <div id="messages">
        <p><em>Connecting...</em></p>
    </div>
    <input type="text" id="message" placeholder="Type your message here...">
    <button id="send">Send</button>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.1/dist/purify.min.js"></script>
    <script>
        const socket = new WebSocket("ws://127.0.0.1:8080/gateway");

        const chat = document.getElementById("messages");
        const sendButton = document.getElementById("send");
        const usernameInput = document.getElementById("username");
        const messageInput = document.getElementById("message");

        socket.onopen = function() {
            console.log("Connected to gateway.");
            chat.innerHTML = "<p><em>Connected!</em></p>";
        };

        socket.onclose = function() {
            console.log("Disconnected from gateway.");
            chat.innerHTML += "<p><em>Disconnected.</em></p>";
        };

        socket.onmessage = function(event) {
            const payload = JSON.parse(event.data);

            switch (Object.keys(payload)[0]) {
                case "MessageCreate":
                    handleMessageReceive(payload);
                    break;
                case "MemberJoin":
                    handleMemberJoin(payload);
                    break;
                case "MemberLeave":
                    handleMemberLeave(payload);
                    break;
                default:
                    console.warn("Unknown event payload received: ", payload);
            }
        };

        sendButton.onclick = function() {
            const content = messageInput.value;
            messageInput.value = "";
            const author =usernameInput.value;
            const data = {"MessageCreate": { author: DOMPurify.sanitize(author), content: DOMPurify.sanitize(content) }};

            // Don't send empty messages
            if (!author || !content) {
                return;
            }

            sendData(JSON.stringify(data));
            // So the user can see their own sent messages
            handleMessageReceive(data);
        };

        const sendData = (data) => {
        if (socket.readyState === WebSocket.OPEN) {
            socket.send(data)
        } else if (socket.readyState == WebSocket.CONNECTING) {
            console.log('Still connecting...');
            socket.addEventListener('open', () => sendData())
        } else {
            console.log('Socket is closed, trying again in 2 seconds...');
            setTimeout(() => sendData(data), 2000)

            }
        };

        const handleMessageReceive = (payload) => {
            const author = DOMPurify.sanitize(payload.MessageCreate.author);
            const content = DOMPurify.sanitize(payload.MessageCreate.content);

            // Don't render empty messages (this shouldn't happen but just in case)
            if (author && content) {
                chat.innerHTML += `<p>${author}: ${content}</p>`;
            }
        };

        const handleMemberJoin = (payload) => {
            const user = DOMPurify.sanitize(payload.MemberJoin);

            // Don't render empty messages (this shouldn't happen but just in case)
            if (user) {
                chat.innerHTML += `<p><i>${user} joined the channel.</i></p>`;
            }
        };

        const handleMemberLeave = (payload) => {
            const user = DOMPurify.sanitize(payload.MemberLeave);

            // Don't render empty messages (this shouldn't happen but just in case)
            if (user) {
                chat.innerHTML += `<p><i>${user} left the channel.</i></p>`;
            }
        };
    </script>
</body>
</html>