<!DOCTYPE html>
<html>
<head>
    <title>Chat App</title>
    <style>
        #messages {
            min-height: 500px;
            overflow-y: scroll;
        }
    </style>
</head>
<body>
    <h1>Chat App</h1>
    <input type="text" id="username" placeholder="Enter your username...">
    <div id="messages">
        <p><em>Connecting...</em></p>
    </div>
    <input type="text" id="message" placeholder="Type your message here...">
    <button id="send">Send</button>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.1/dist/purify.min.js"></script>
    <script>
        const gateway = new WebSocket("ws://127.0.0.1:8080/gateway");

        const chat = document.getElementById("messages");
        const sendButton = document.getElementById("send");
        const usernameInput = document.getElementById("username");
        const messageInput = document.getElementById("message");

        gateway.onopen = () => {
            console.log("Connected to gateway.");
            chat.innerHTML = "<p><em>Connected!</em></p>";
        };

        gateway.onclose = () => {
            console.log("Disconnected from gateway.");
            chat.innerHTML += "<p><em>Disconnected.</em></p>";
        };

        gateway.onmessage = (event) => {
            const payload = JSON.parse(event.data);

            switch (Object.keys(payload)[0]) {
                case "MessageCreate":
                    handleMessageReceive(payload.MessageCreate);
                    break;
                case "MemberJoin":
                    handleMemberJoin(payload.MemberJoin);
                    break;
                case "MemberLeave":
                    handleMemberLeave(payload.MemberLeave);
                    break;
                default:
                    console.warn("Unknown event payload received: ", payload);
            }
        };

        sendButton.addEventListener("click", async () => {
            // TODO: Set up a gateway event that provides user info on connect
            var message = {
                author: {
                    id: 0, 
                    username: DOMPurify.sanitize(usernameInput.value)
                }, 
                content: DOMPurify.sanitize(messageInput.value)
            };

            messageInput.value = "";
            // Don't send empty messages
            if (!message.content || !message.author.username) {
                return;
            }
            await sendMessage(message);
            // So the user can see their own sent messages
            handleMessageReceive(message);
        });

        // Create a message using the REST API
        const sendMessage = async (message) => {
            const response = await fetch('http://127.0.0.1:8080/message/create', {
                method: 'POST',
                body: JSON.stringify(message),
                headers: {
                'Content-Type': 'application/json',
                }
            });
            if (!response.ok) {
                const message = `An error has occured: ${response.status}`;
                throw new Error(message);
            }
}

        // Deprecated: Use the REST API instead
        const sendGatewayData = (data) => {
        if (gateway.readyState === WebSocket.OPEN) {
            gateway.send(data)
        } else if (gateway.readyState == WebSocket.CONNECTING) {
            console.log('Still connecting...');
            gateway.addEventListener('open', () => sendGatewayData())
        } else {
            console.log('Socket is closed, trying again in 2 seconds...');
            setTimeout(() => sendGatewayData(data), 2000)

            }
        };

        const handleMessageReceive = (message) => {
            const author = DOMPurify.sanitize(message.author.username);
            const content = DOMPurify.sanitize(message.content);

            // Don't render empty messages (this shouldn't happen but just in case)
            if (author && content) {
                chat.innerHTML += `<p>${author}: ${content}</p>`;
            }
        };

        const handleMemberJoin = (username) => {
            const user = DOMPurify.sanitize(username);

            // Don't render empty messages (this shouldn't happen but just in case)
            if (user) {
                chat.innerHTML += `<p><i>${user} joined the channel.</i></p>`;
            }
        };

        const handleMemberLeave = (username) => {
            const user = DOMPurify.sanitize(username);

            // Don't render empty messages (this shouldn't happen but just in case)
            if (user) {
                chat.innerHTML += `<p><i>${user} left the channel.</i></p>`;
            }
        };
    </script>
</body>
</html>